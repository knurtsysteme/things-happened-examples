/*! things-happened-angular v0.3.0 | (c) 2013-2014 KNURT Systeme | MIT License */
"use strict";angular.module("thingsHappened",[]),angular.module("thingsHappened").factory("thingsDao",["$http",function(a){var b={},c=function(a){var b={};return a=a||"invalid request - server not contacted",b.error=function(b){b(a)},b.success=function(){},b};return b.get=function(b){var d=b.url(),e={};return e=d?a.get(b.url()):c()},b.add=function(b){var d=b.url(),e=b.getThing(),f={};return f=d&&e?a.post(d,e):c()},b}]),angular.module("thingsHappened").directive("thingsAddto",["$compile","thingsDao",function(a,b){var c=function(a,b,c,d,e,f){return e=e||function(a){window.alert("Your new document stored: "+JSON.stringify(a))},f=f||function(){window.alert("YES! ... an error occured :(")},function(){var g=things.query.add(this[d]).to(a,b);return c.add(g).success(e).error(f),!1}},d=1,e=function(){return"things"+d++},f={compile:function(){return{post:function(d,f,g){var h=g.thingsAddto,i=h.match(/^\s*([a-z]+)\s+([a-z]+)(.*)$/);if(i){var j=i[1],k=i[2],l=g.thingsSuccess||!1;l&&(l=d[l]);var m=g.thingsError||!1;m&&(m=d[m]);var n=e(),o=n+"Function";d[n]={},d[o]=c(j,k,b,n,l,m);var p=f.clone().wrap("<div />").parent().html();p=p.replace(/name\s*=\s*"/g,'ng-model="'+n+"."),p=p.replace(/name\s*=\s*'/g,"ng-model='"+n+"."),f.html(p),f.attr("ng-model",n),f.attr("ng-submit",o+"()"),f.removeAttr("things-addto"),a(f)(d)}}}}};return f}]),angular.module("thingsHappened").directive("thingsCount",["thingsDao",function(a){return{scope:{thingsCount:"=",thingsHappened:"="},link:function(b,c){var d=function(){if(b.thingsCount){var d=things.query.count(b.thingsCount);b.thingsHappened&&d.that(b.thingsHappened),a.get(d).success(function(a){c.text(a.result)})}else a.get(things.query.count()).success(function(a){c.text(a._total)})};b.$watch(function(){return b.thingsCount+b.thingsHappened},d)}}}]),angular.module("thingsHappened").controller("thingsCtrl",["$scope","thingsDao",function(a,b){a.add=b.add}]),angular.module("thingsHappened").directive("thingsRepeat",["$compile","thingsDao",function(a,b){var c=function(c,d){var e=d.clone();d.css("display","none");var f=function(){var f=c.thingsRepeat.match(/^\s*([\s\S]+?)\s+in\s+([a-z]+)(.*)$/);if(f){var g=f[2],h=e.clone().wrap("<div />").parent().html();d.parent().html(d);var i=things.query.select(g,{criteria:c.thingsCriteria,projection:c.thingsProjection});b.get(i).success(function(b){c[g]=b;var e=angular.element(h);e.attr("ng-repeat",c.thingsRepeat),e.removeAttr("things-repeat"),a(e)(c),d.after(e)})}};c.$watch(function(){return c.thingsRepeat+angular.toJson(c.thingsCriteria)+c.thingsProjection},f)};return{replace:!0,restrict:"A",scope:{thingsRepeat:"@",thingsCriteria:"=",thingsProjection:"="},compile:function(){return{post:c}}}}]);